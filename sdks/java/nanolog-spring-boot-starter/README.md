# NanoLog Spring Boot Starter

é«˜æ€§èƒ½ã€è½»é‡çº§çš„æ—¥å¿—æ”¶é›† SDKï¼Œå°† Logback æ—¥å¿—å¼‚æ­¥å‘é€åˆ° NanoLog Serverã€‚

[![Maven Central](https://img.shields.io/maven-central/v/tech.coffers/nanolog-spring-boot-starter)](https://central.sonatype.com/artifact/tech.coffers/nanolog-spring-boot-starter)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)

## âœ¨ ç‰¹æ€§

- ğŸš€ **å¼‚æ­¥æ‰¹é‡å‘é€** - åå° Worker çº¿ç¨‹æ‰¹é‡å¤„ç†ï¼Œé›¶é˜»å¡ä¸»çº¿ç¨‹
- ğŸ”„ **æŒ‡æ•°é€€é¿é‡è¯•** - å‘é€å¤±è´¥è‡ªåŠ¨é‡è¯• (100ms â†’ 200ms â†’ 400ms)
- ğŸ’¾ **æœ¬åœ°é™çº§å­˜å‚¨** - ç½‘ç»œä¸å¯ç”¨æ—¶å†™å…¥æœ¬åœ°æ–‡ä»¶ï¼ŒæœåŠ¡æ¢å¤åè‡ªåŠ¨é‡å‘
- âš™ï¸ **Spring Boot è‡ªåŠ¨é…ç½®** - å¼€ç®±å³ç”¨ï¼Œé›¶ä»£ç é›†æˆ
- ğŸ“Š **è½»é‡é«˜æ•ˆ** - æ— é¢å¤–ä¾èµ–ï¼Œå†…å­˜å ç”¨æä½

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Your Application                                â”‚
â”‚                                                                              â”‚
â”‚     log.info()         log.error()         log.warn()                       â”‚
â”‚         â”‚                   â”‚                   â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                   â”‚                   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              NanoLog SDK                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    BlockingQueue (10000)                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                               â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚              â–¼                               â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚     Worker Thread       â”‚    â”‚    Recovery Thread      â”‚                â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚      (æ¯åˆ†é’Ÿ)            â”‚                â”‚
â”‚  â”‚  â”‚  Batch Builder    â”‚  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â”‚ è¯»å– fallback.log â”‚  â”‚                â”‚
â”‚  â”‚            â–¼            â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚            â–¼            â”‚                â”‚
â”‚  â”‚  â”‚   Retry Logic     â”‚  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                â”‚
â”‚  â”‚  â”‚ 100â†’200â†’400ms     â”‚  â”‚    â”‚  â”‚   Ping Server     â”‚  â”‚                â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚            â–¼            â”‚                â”‚
â”‚               â”‚                 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                â”‚
â”‚               â”‚                 â”‚  â”‚   é‡å‘æ—¥å¿—         â”‚  â”‚                â”‚
â”‚               â”‚                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                â”‚
â”‚               â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚               â”‚                              â”‚                              â”‚
â”‚               â”‚ 3æ¬¡å¤±è´¥                       â”‚                              â”‚
â”‚               â–¼                              â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚                              â”‚
â”‚  â”‚     Fallback File       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚  â”‚ /tmp/nanolog/fallback/  â”‚                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚ æˆåŠŸ
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     NanoLog Server      â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚   /api/ingest     â”‚  â”‚
                    â”‚  â”‚   /api/ping       â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‘é€æµç¨‹

```
Application              Queue              Worker             Server           Fallback
    â”‚                      â”‚                  â”‚                   â”‚                 â”‚
    â”‚  log.info("msg")     â”‚                  â”‚                   â”‚                 â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                   â”‚                 â”‚
    â”‚                      â”‚   poll(100ms)    â”‚                   â”‚                 â”‚
    â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                 â”‚
    â”‚                      â”‚   æ—¥å¿—äº‹ä»¶        â”‚                   â”‚                 â”‚
    â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                 â”‚
    â”‚                      â”‚                  â”‚                   â”‚                 â”‚
    â”‚                      â”‚                  â”‚ POST /api/ingest  â”‚                 â”‚
    â”‚                      â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
    â”‚                      â”‚                  â”‚                   â”‚                 â”‚
    â”‚                      â”‚                  â”‚   [æˆåŠŸ] 200 OK   â”‚                 â”‚
    â”‚                      â”‚                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
    â”‚                      â”‚                  â”‚                   â”‚                 â”‚
    â”‚                      â”‚                  â”‚   [å¤±è´¥] ç­‰å¾…100ms â”‚                 â”‚
    â”‚                      â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
    â”‚                      â”‚                  â”‚   [å¤±è´¥] ç­‰å¾…200ms â”‚                 â”‚
    â”‚                      â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
    â”‚                      â”‚                  â”‚   [å¤±è´¥] ç­‰å¾…400ms â”‚                 â”‚
    â”‚                      â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
    â”‚                      â”‚                  â”‚                   â”‚                 â”‚
    â”‚                      â”‚                  â”‚  [3æ¬¡å¤±è´¥] å†™å…¥    â”‚                 â”‚
    â”‚                      â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                      â”‚                  â”‚                   â”‚                 â”‚
```

---

## ğŸ“¦ å®‰è£…

### Maven

```xml
<dependency>
    <groupId>tech.coffers</groupId>
    <artifactId>nanolog-spring-boot-starter</artifactId>
    <version>0.1.6</version>
</dependency>
```

### Gradle

```groovy
implementation 'tech.coffers:nanolog-spring-boot-starter:0.1.6'
```

---

## âš™ï¸ é…ç½®

åœ¨ `application.yml` ä¸­æ·»åŠ é…ç½®ï¼š

```yaml
nanolog:
  # è®¤è¯é…ç½®
  token: sk-xxxxxxxxxxxxxxxx             # API Token (ä»‹ç» in Server UI)

  # åŸºç¡€é…ç½®
  enabled: true                              # æ˜¯å¦å¯ç”¨ (é»˜è®¤: true)
  server-url: http://localhost:8080          # NanoLog Server åœ°å€
  service: ${spring.application.name}        # æœåŠ¡åç§°

  # æ€§èƒ½è°ƒä¼˜
  batch-size: 100                            # æ‰¹é‡å¤§å° (é»˜è®¤: 100)
  flush-interval-ms: 1000                    # åˆ·æ–°é—´éš”æ¯«ç§’ (é»˜è®¤: 1000)

  # å®¹é”™é…ç½®
  enable-fallback: true                      # å¯ç”¨æœ¬åœ°é™çº§ (é»˜è®¤: true)
  fallback-path: /tmp/nanolog/fallback       # é™çº§æ–‡ä»¶è·¯å¾„
```

### é…ç½®é¡¹è¯´æ˜

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `nanolog.token` | string | `""` | **API Token** (å¿…å¡«)****** |
| `nanolog.enabled` | boolean | `true` | æ˜¯å¦å¯ç”¨ NanoLog |
| `nanolog.server-url` | string | `http://localhost:8080` | NanoLog Server åœ°å€ |
| `nanolog.service` | string | `default` | æœåŠ¡æ ‡è¯†ï¼Œç”¨äºåŒºåˆ†æ—¥å¿—æ¥æº |
| `nanolog.batch-size` | int | `100` | æ¯æ‰¹å‘é€çš„æ—¥å¿—æ¡æ•° |
| `nanolog.flush-interval-ms` | long | `1000` | æœ€å¤§åˆ·æ–°é—´éš” (ms) |
| `nanolog.enable-fallback` | boolean | `true` | æ˜¯å¦å¯ç”¨æœ¬åœ°é™çº§å­˜å‚¨ |
| `nanolog.fallback-path` | string | `/tmp/nanolog/fallback` | é™çº§æ–‡ä»¶å­˜å‚¨ç›®å½• |

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨

SDK ä¼šè‡ªåŠ¨æ³¨å†Œåˆ° ROOT Loggerï¼Œæ— éœ€ä»»ä½•ä»£ç ä¿®æ”¹ï¼š

```java
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@RestController
public class UserController {

    private static final Logger log = LoggerFactory.getLogger(UserController.class);

    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) {
        log.info("Fetching user with id: {}", id);
        
        try {
            User user = userService.findById(id);
            log.debug("User found: {}", user.getName());
            return user;
        } catch (Exception e) {
            log.error("Failed to fetch user: {}", id, e);
            throw e;
        }
    }
}
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹

```yaml
# application-prod.yml
nanolog:
  enabled: true
  server-url: http://nanolog.internal.example.com:8080
  service: user-service
  batch-size: 200                    # ç”Ÿäº§ç¯å¢ƒå¯é€‚å½“å¢å¤§æ‰¹æ¬¡
  flush-interval-ms: 500             # ç¼©çŸ­åˆ·æ–°é—´éš”ï¼Œé™ä½å»¶è¿Ÿ
  enable-fallback: true
  fallback-path: /var/log/nanolog/fallback  # ä½¿ç”¨æŒä¹…åŒ–ç›®å½•
```

### ç¦ç”¨ NanoLog

åœ¨ç‰¹å®šç¯å¢ƒï¼ˆå¦‚æœ¬åœ°å¼€å‘ï¼‰ç¦ç”¨ï¼š

```yaml
# application-local.yml
nanolog:
  enabled: false
```

---

## ğŸ”§ å®¹é”™æœºåˆ¶

### æŒ‡æ•°é€€é¿é‡è¯•

å½“å‘é€å¤±è´¥æ—¶ï¼ŒSDK ä¼šæŒ‰ä»¥ä¸‹ç­–ç•¥é‡è¯•ï¼š

| é‡è¯•æ¬¡æ•° | ç­‰å¾…æ—¶é—´ | ç´¯è®¡æœ€å¤§è€—æ—¶ |
|----------|----------|--------------|
| ç¬¬ 1 æ¬¡  | 100ms    | 100ms        |
| ç¬¬ 2 æ¬¡  | 200ms    | 300ms        |
| ç¬¬ 3 æ¬¡  | 400ms    | 700ms        |

### æœ¬åœ°é™çº§

å¦‚æœ 3 æ¬¡é‡è¯•å…¨éƒ¨å¤±è´¥ï¼Œæ—¥å¿—æ‰¹æ¬¡å°†å†™å…¥æœ¬åœ°æ–‡ä»¶ï¼š

```
/tmp/nanolog/fallback/fallback.log
```

æ–‡ä»¶æ ¼å¼ä¸ºæ¯è¡Œä¸€ä¸ª JSON æ•°ç»„ï¼š

```json
[{"timestamp":1735707600000000000,"level":"1","service":"my-service","host":"server-01","message":"User login"}]
[{"timestamp":1735707601000000000,"level":"3","service":"my-service","host":"server-01","message":"DB timeout"}]
```

### è‡ªåŠ¨æ¢å¤

åå° Recovery çº¿ç¨‹æ¯ **60 ç§’** æ‰§è¡Œä¸€æ¬¡ï¼š

1. æ£€æŸ¥ `fallback.log` æ˜¯å¦å­˜åœ¨
2. è°ƒç”¨ `/api/ping` æ¢æµ‹ Server å¯ç”¨æ€§
3. å¦‚æœå¯ç”¨ï¼Œè¯»å–å¹¶é‡å‘æ‰€æœ‰æ—¥å¿—
4. å‘é€æˆåŠŸååˆ é™¤æœ¬åœ°æ–‡ä»¶

---

## ğŸ“Š æ€§èƒ½å‚è€ƒ

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| é˜Ÿåˆ—å®¹é‡ | 10,000 æ¡ |
| å†…å­˜å ç”¨ | < 10MB |
| ååé‡ | 50,000+ logs/sec |
| æ‰¹é‡å»¶è¿Ÿ | < 1 ç§’ (å¯é…ç½®) |

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [NanoLog Server](https://github.com/coffersTech/nanolog)
- [é—®é¢˜åé¦ˆ](https://github.com/coffersTech/nanolog/issues)

---

## ğŸ“„ License

MIT License Â© 2024 Coffers Tech
